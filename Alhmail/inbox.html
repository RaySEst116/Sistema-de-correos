<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bandeja de Entrada - Alhmail</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script>if (!localStorage.getItem('alhmail_token')) window.location.href = 'index.html';</script>

    <style>
        /* VARIABLES & RESET */
        :root { --primary-red: #D50032; --bg-color: #f9fafb; --text-color: #374151; }
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { display: flex; height: 100vh; background-color: var(--bg-color); overflow: hidden; padding-right: 0 !important; }
        body.swal2-shown { height: 100vh !important; overflow-y: hidden !important; }

        /* SIDEBAR */
        .sidebar { width: 250px; background: white; display: flex; flex-direction: column; padding: 20px 10px; border-right: 1px solid #e5e7eb; transition: 0.3s; z-index: 100; flex-shrink: 0; }
        .sidebar.collapsed { width: 80px; padding: 20px 5px; }
        .sidebar-header { display: flex; justify-content: space-between; margin-bottom: 30px; padding: 0 10px; align-items: center; height: 40px; }
        .logo-text { font-size: 1.5rem; font-weight: bold; color: var(--primary-red); white-space: nowrap; overflow: hidden; opacity: 1; transition: opacity 0.2s; }
        .sidebar.collapsed .logo-text { display: none; opacity: 0; }
        .toggle-btn { background: none; border: none; cursor: pointer; font-size: 1.4rem; color: #555; width: 40px; }
        
        .compose-btn { background: var(--primary-red); color: white; border: none; height: 45px; width: 90%; margin: 0 auto 30px auto; border-radius: 50px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.2s; white-space: nowrap; overflow: hidden; box-shadow: 0 2px 5px rgba(213,0,50,0.3); flex-shrink: 0; }
        .compose-btn:hover { background: #C20049; transform: translateY(-1px); }
        .sidebar.collapsed .compose-btn { width: 45px; padding: 0; border-radius: 50%; gap: 0; }
        .sidebar.collapsed .compose-btn span { display: none; }
        .sidebar.collapsed .compose-btn i { margin: 0; font-size: 1.2rem; }

        .nav-list { list-style: none; flex-grow: 1; overflow-y: auto; overflow-x: hidden; }
        .nav-item { display: flex; align-items: center; padding: 12px 20px; margin-bottom: 5px; color: #555; border-radius: 8px; cursor: pointer; transition: 0.2s; white-space: nowrap; }
        .nav-item:hover { background: #f3f4f6; color: var(--primary-red); }
        .nav-item.active { background: #fee2e2; color: var(--primary-red); font-weight: 600; }
        .nav-item i { width: 25px; margin-right: 10px; text-align: center; font-size: 1.1rem; flex-shrink: 0; }
        .sidebar.collapsed .nav-item { justify-content: center; padding: 12px 0; }
        .sidebar.collapsed .nav-item span { display: none; }
        .sidebar.collapsed .nav-item i { margin: 0; }

        .sidebar-footer { border-top: 1px solid #eee; padding-top: 15px; padding-bottom: 10px; margin-top: auto; display: flex; flex-direction: column; align-items: center; gap: 8px; flex-shrink: 0; overflow: hidden; width: 100%; }
        .footer-item { width: 90%; height: 40px; display: flex; align-items: center; justify-content: center; color: #555; border-radius: 8px; cursor: pointer; transition: 0.2s; white-space: nowrap; font-size: 0.9rem; font-weight: 600; }
        .footer-item:hover { background: #f3f4f6; color: var(--primary-red); }
        .footer-item i { margin-right: 8px; font-size: 1.1rem; }
        
        /* Estilo Botón Admin */
        .footer-item.admin { background: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .footer-item.admin:hover { background: #047857; color: white; }
        
        .footer-item.logout { color: #ef4444; background: #fff1f1; border: 1px solid #fecaca; }
        .footer-item.logout:hover { background: #ef4444; color: white; border-color: #ef4444; }
        
        .sidebar.collapsed .footer-item { width: 45px; padding: 0; border-radius: 50%; }
        .sidebar.collapsed .footer-item span { display: none; }
        .sidebar.collapsed .footer-item i { margin: 0; }

        /* MAIN CONTENT */
        .main-content { flex-grow: 1; background: white; margin: 10px; border-radius: 10px; display: flex; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.05); min-width: 0; }
        .email-list { width: 400px; display: flex; flex-direction: column; border-right: 1px solid #eee; flex-shrink: 0; }
        .list-header { padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .search-container { position: relative; width: 100%; }
        .search-input { width: 100%; padding: 8px 10px 8px 35px; border: 1px solid #eee; border-radius: 6px; background: #f9fafb; outline: none; }
        .search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: #999; }
        .list-tools { padding: 10px 15px; background: #f8f9fa; border-bottom: 1px solid #eee; display: flex; align-items: center; gap: 15px; }
        .tool-btn { background: none; border: none; cursor: pointer; color: #666; font-size: 1rem; }
        .tool-btn:hover { color: var(--primary-red); }
        .master-check, .email-check { appearance: none; width: 18px; height: 18px; border: 2px solid #cbd5e1; border-radius: 4px; cursor: pointer; background: white; position: relative; flex-shrink: 0; }
        .master-check:checked, .email-check:checked { background: var(--primary-red); border-color: var(--primary-red); }
        .master-check:checked::after, .email-check:checked::after { content: ''; position: absolute; left: 5px; top: 1px; width: 4px; height: 10px; border: solid white; border-width: 0 2px 2px 0; transform: rotate(45deg); }

        #emailContainer { overflow-y: auto; flex-grow: 1; }
        .fake-email { padding: 15px; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; gap: 12px; align-items: flex-start; transition: 0.2s; border-left: 4px solid transparent; }
        .fake-email:hover { background: #f9fafb; border-left-color: #e5e7eb; }
        .fake-email.unread { background: white; font-weight: bold; border-left-color: var(--primary-red); }
        .fake-email.row-checked { background-color: #fee2e2 !important; border-left-color: var(--primary-red) !important; }
        .fake-email.selected { background-color: #f3f4f6; border-left-color: #666; }
        .email-content { flex-grow: 1; overflow: hidden; display: flex; flex-direction: column; gap: 2px; }
        .email-from { font-size: 0.95rem; color: #374151; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }
        .email-to { font-size: 0.8rem; color: #6b7280; display: block; margin-bottom: 4px; }
        .email-check { margin-top: 4px; }

        .email-preview { flex-grow: 1; padding: 30px; overflow-y: auto; display: flex; flex-direction: column; width: 100%; overflow-x: hidden; }
        .detail-header { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px; }
        .detail-subject { font-size: 1.6rem; color: #111827; margin-bottom: 15px; font-weight: 600; line-height: 1.3; }
        .meta-container { display: flex; justify-content: space-between; align-items: flex-start; }
        .sender-info { display: flex; align-items: center; gap: 15px; flex-grow: 1; }
        .sender-avatar { width: 45px; height: 45px; border-radius: 50%; background-color: var(--primary-red); color: white; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; font-weight: bold; flex-shrink: 0; }
        .meta-text { display: flex; flex-direction: column; }
        .from-line { font-size: 1rem; color: #374151; }
        .action-bar-top { display: flex; gap: 10px; }
        .action-btn { padding: 6px 12px; border: 1px solid #ddd; background: white; border-radius: 4px; cursor: pointer; color: #555; }
        .action-btn:hover { background: #f3f4f6; color: var(--primary-red); border-color: var(--primary-red); }
        .detail-body { line-height: 1.6; font-size: 1rem; color: #333; margin-top: 20px; overflow-wrap: break-word; }
        .detail-body img { max-width: 100%; height: auto; }

        /* MODALES (SISTEMA UNIFICADO) */
        /* Clase base para cualquier modal */
        .modal-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 2000; 
            display: flex; align-items: center; justify-content: center; 
            opacity: 0; pointer-events: none; transition: opacity 0.2s;
        }
        /* Cuando está activo se ve */
        .modal-overlay.active { opacity: 1; pointer-events: all; }

        /* Cards dentro de los modales */
        .modal-card { background: white; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); display: flex; flex-direction: column; }
        
        /* Modal Cuenta */
        .account-card { width: 400px; padding: 30px; }
        /* Modal Usuarios (Admin) */
        .users-card { width: 800px; max-height: 80vh; padding: 20px; }
        
        /* Modal Redactar (Comportamiento especial slide-up) */
        .compose-modal { 
            position: fixed; bottom: 0; right: 80px; width: 600px; height: 700px; 
            background: white; box-shadow: 0 0 20px rgba(0,0,0,0.2); z-index: 1000; 
            display: flex; flex-direction: column; border-radius: 10px 10px 0 0; 
            transition: 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); transform: translateY(120%);
        }
        .compose-modal.active { transform: translateY(0); }
        .compose-modal.minimized { height: 45px; width: 250px; overflow: hidden; }
        .compose-modal.maximized { width: 100%; height: 100%; right: 0; bottom: 0; border-radius: 0; }

        /* Estilos internos de modales */
        .compose-header, .users-header { background: #f3f4f6; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #ddd; cursor: pointer; border-radius: 10px 10px 0 0; }
        .window-btn { background: none; border: none; cursor: pointer; padding: 6px; color: #666; border-radius: 4px; }
        .window-btn:hover { background: rgba(0,0,0,0.1); color: var(--primary-red); }
        .window-btn.close-btn:hover { background-color: #e81123; color: white; }
        
        .compose-body, .users-body { flex-grow: 1; padding: 15px; overflow-y: auto; position: relative; }
        .input-group { display: flex; border-bottom: 1px solid #eee; margin-bottom: 5px; align-items: center; position: relative; }
        .input-group label { color: #666; font-weight: 600; font-size: 0.9rem; margin-right: 10px; min-width: 35px; }
        .input-group input { flex-grow: 1; border: none; padding: 12px 10px; outline: none; font-family: inherit; }
        .cc-link { font-size: 0.8rem; color: #666; cursor: pointer; margin-left: 10px; font-weight: 600; padding: 5px; }
        .hidden-field { display: none !important; }
        .remove-field-btn { background: none; border: none; color: #9ca3af; cursor: pointer; padding: 0 10px; font-size: 0.9rem; }
        #editor-container { height: 100%; border: none !important; }
        .compose-footer { padding: 15px; display: flex; justify-content: space-between; border-top: 1px solid #eee; background: #f9fafb; border-radius: 0 0 10px 10px; }
        
        /* Chips */
        .chip-container { flex-grow: 1; display: flex; flex-wrap: wrap; align-items: center; gap: 5px; border: 1px solid transparent; padding: 5px; min-height: 45px; }
        .email-chip { display: flex; align-items: center; background: #e8f0fe; color: #1967d2; padding: 4px 8px; border-radius: 16px; font-size: 0.9rem; font-weight: 500; }
        .chip-close { margin-left: 6px; cursor: pointer; font-size: 1rem; opacity: 0.6; }
        .chip-input { flex-grow: 1; border: none; outline: none; padding: 8px; min-width: 120px; font-family: inherit; }
        .autocomplete-list { position: absolute; top: 100%; left: 50px; right: 0; background: white; border: 1px solid #ddd; z-index: 100; max-height: 200px; overflow-y: auto; display: none; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .autocomplete-list.visible { display: block; }
        .suggestion-item { padding: 10px; cursor: pointer; border-bottom: 1px solid #eee; }
        .suggestion-item:hover { background: #f9fafb; }

        /* Tabla Usuarios */
        .user-table { width: 100%; border-collapse: collapse; }
        .user-table th { text-align: left; padding: 12px; border-bottom: 2px solid #f3f4f6; color: #666; font-weight: 600; font-size: 0.9rem; }
        .user-table td { padding: 12px; border-bottom: 1px solid #eee; color: #333; }
        .role-tag { padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: bold; text-transform: uppercase; }
        .role-tag.admin { background: #fee2e2; color: #D50032; }
        .role-tag.user { background: #e0e7ff; color: #4338ca; }
        .btn-action { border: none; background: none; cursor: pointer; padding: 5px; font-size: 1rem; transition: 0.2s; border-radius: 4px; }
        .btn-edit { color: #3b82f6; }
        .btn-delete { color: #ef4444; }
        .btn-create { background: var(--primary-red); color: white; border: none; padding: 8px 15px; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.9rem; display: flex; align-items: center; gap: 5px; }
    
        /* Account Form */
        .account-form label { display: block; margin-top: 15px; font-weight: 600; font-size: 0.9rem; color: #374151; }
        .account-form input, .account-form select { width: 100%; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; outline: none; margin-top: 5px; }
        .account-form input:disabled { background: #f3f4f6; color: #9ca3af; cursor: not-allowed; }
        .role-badge { display: inline-block; padding: 4px 10px; border-radius: 15px; font-size: 0.8rem; font-weight: bold; margin-bottom: 15px; }
        .role-admin { background: #fee2e2; color: var(--primary-red); }
        .role-user { background: #e0e7ff; color: #4338ca; }
        .send-btn { background-color: var(--primary-red); color: white; border: none; padding: 8px 24px; border-radius: 4px; font-weight: 600; cursor: pointer; }
        
        #drag-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:50; display:none; flex-direction:column; align-items:center; justify-content:center; color:var(--primary-red); font-weight:bold; border: 3px dashed var(--primary-red); }
        .attachments-section { margin-top: 10px; border-top: 1px solid #eee; padding-top: 5px; max-height: 80px; overflow-y: auto; }
        .file-chip { display: inline-flex; align-items: center; background: #f3f4f6; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; margin-right: 5px; border: 1px solid #ddd; }
        .file-remove { margin-left: 5px; cursor: pointer; color: #ef4444; }
        .ai-btn { background: linear-gradient(135deg, #8b5cf6, #d946ef); color: white; border: none; padding: 8px 15px; border-radius: 20px; font-size: 0.85rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .footer-left, .footer-right { display: flex; gap: 10px; align-items: center; }
        .tool-btn { background: none; border: none; cursor: pointer; color: #666; font-size: 1rem; }
    </style>
</head>
<body>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="logo-text">Alhmail</div>
            <button class="toggle-btn" id="toggleBtn"><i class="fas fa-bars"></i></button>
        </div>
        
        <button class="compose-btn" id="composeBtn">
            <i class="fas fa-plus"></i><span>Redactar</span>
        </button>
        
        <div class="nav-list">
            <div class="nav-item active" data-target="inbox"><i class="fas fa-inbox"></i><span>Entrada</span></div>
            <div class="nav-item" data-target="sent"><i class="fas fa-paper-plane"></i><span>Enviados</span></div>
            <div class="nav-item" data-target="drafts"><i class="fas fa-file"></i><span>Borradores</span></div>
            <div class="nav-item" data-target="spam" id="navSpam" style="display:none; color:#d97706;"><i class="fas fa-exclamation-triangle"></i><span>Spam</span></div>
        </div>

        <div class="sidebar-footer">
            <div class="footer-item admin" id="adminUsersBtn" style="display:none;">
                <i class="fas fa-users-cog"></i><span>Usuarios</span>
            </div>
            <div class="footer-item" id="accountBtn">
                <i class="fas fa-user-circle"></i><span>Mi Cuenta</span>
            </div>
            <div class="footer-item logout" id="logoutBtn">
                <i class="fas fa-sign-out-alt"></i><span>Cerrar Sesión</span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="email-list">
            <div class="list-header">
                <div class="header-top">
                    <h3 id="folderTitle" style="color:var(--primary-red); margin:0;">Bandeja de Entrada</h3>
                    <button class="tool-btn" id="refreshBtn" title="Actualizar"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div class="search-container">
                    <i class="fas fa-search search-icon"></i>
                    <input type="text" id="searchInput" class="search-input" placeholder="Buscar...">
                </div>
            </div>
            <div class="list-tools">
                <input type="checkbox" id="selectAll" class="master-check" title="Seleccionar Todo">
                <div style="width:1px; height:20px; background:#ddd; margin:0 10px;"></div>
                <button class="tool-btn" id="deleteSelected" title="Eliminar"><i class="far fa-trash-alt"></i></button>
                <button class="tool-btn" id="markRead" title="Marcar Leído"><i class="far fa-envelope-open"></i></button>
                <div style="width:1px; height:20px; background:#ddd; margin:0 10px;"></div>
                <button class="tool-btn" id="sortBtn" title="Ordenar"><i class="fas fa-sort-amount-down"></i></button>
            </div>
            <div id="emailContainer">Cargando...</div>
        </div>
        <div class="email-preview" id="previewPanel">
            <div style="text-align:center; color:#999; margin-top:100px;">
                <i class="far fa-envelope" style="font-size:4rem; opacity:0.5;"></i>
                <p style="margin-top:20px;">Selecciona un correo para leer</p>
            </div>
        </div>
    </main>

    <div class="compose-modal" id="composeModal">
        <div class="compose-header" id="composeHeader">
            <span id="modalTitle" style="font-weight:600;">Mensaje Nuevo</span>
            <div class="window-actions">
                <button class="window-btn" id="btnMin"><i class="fas fa-minus"></i></button>
                <button class="window-btn" id="btnMax"><i class="fas fa-expand"></i></button>
                <button class="window-btn" id="btnCloseX"><i class="fas fa-times"></i></button>
            </div>
        </div>
        <div class="compose-body" id="dropZone">
            <div id="drag-overlay"><i class="fas fa-cloud-upload-alt" style="font-size:3rem; margin-bottom:10px;"></i><br>Suelta archivos aquí</div>
            <div class="input-group"><label>De:</label><input type="text" id="from" disabled style="background:white; color:#333; font-weight:600;"></div>
            <div class="input-group" style="align-items: flex-start; padding-top: 5px;">
                <label style="margin-top: 8px;">Para:</label>
                <div class="chip-container" id="to-chips-container" onclick="document.getElementById('to-input').focus()"><input type="text" id="to-input" class="chip-input" placeholder=""></div>
                 <div class="cc-bcc-container" style="position:absolute; right:10px; background:white;">
                    <span class="cc-link" id="btnCc">Cc</span><span class="cc-link" id="btnBcc">Cco</span>
                </div>
                <div class="autocomplete-list" id="autocompleteList"></div>
            </div>
            <div class="input-group hidden-field" id="ccField" style="align-items:flex-start; padding-top:5px;"><label style="margin-top:8px;">Cc:</label><div class="chip-container" id="cc-chips-container" onclick="document.getElementById('cc-input').focus()"><input type="text" id="cc-input" class="chip-input"></div></div>
            <div class="input-group hidden-field" id="bccField" style="align-items:flex-start; padding-top:5px;"><label style="margin-top:8px;">Cco:</label><div class="chip-container" id="bcc-chips-container" onclick="document.getElementById('bcc-input').focus()"><input type="text" id="bcc-input" class="chip-input"></div></div>
            <div class="input-group"><input type="text" id="subject" placeholder="Asunto"></div>
            <div id="editor-container"></div>
            <div class="attachments-section"><div id="fileList"></div></div>
        </div>
        <div class="compose-footer">
            <div class="footer-left"><button class="send-btn" id="sendBtn">Enviar</button><button class="ai-btn" id="aiBtn"><i class="fas fa-magic"></i> IA</button></div>
            <div class="footer-right"><input type="file" id="fileInput" multiple style="display:none"><button class="tool-btn" id="attachBtn" title="Adjuntar"><i class="fas fa-paperclip"></i></button><button class="tool-btn" id="discardBtn" title="Descartar"><i class="far fa-trash-alt"></i></button></div>
        </div>
    </div>

    <div class="account-modal modal-overlay" id="accountModal">
        <div class="account-card modal-card">
            <div style="display:flex; justify-content:space-between; align-items: center; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--text-color);" id="accTitle">Mi Cuenta</h3>
                <i class="fas fa-times" id="closeAcc" style="cursor:pointer; color:#999; font-size:1.2rem;"></i>
            </div>
            <div style="text-align:center;"><span id="roleBadge" class="role-badge"></span></div>
            <div class="account-form">
                <label>Nombre</label><input type="text" id="accName" disabled>
                <label>Email</label><input type="text" id="accEmail" disabled>
                <label>Contraseña</label><input type="password" id="accPass" disabled placeholder="********">
                <div id="roleSelectContainer" style="display:none;">
                    <label>Rol</label>
                    <select id="accRole" style="width:100%; padding:10px; border:1px solid #d1d5db; border-radius:6px; margin-top:5px;"><option value="user">Usuario</option><option value="admin">Administrador</option></select>
                </div>
            </div>
            <div style="text-align:right; margin-top:25px;"><button class="send-btn" id="saveAcc" style="display:none;">Guardar Cambios</button></div>
        </div>
    </div>

    <div class="users-modal modal-overlay" id="usersModal">
        <div class="users-card modal-card">
            <div class="users-header">
                <h3 style="margin:0; color:var(--primary-red);">Gestión de Usuarios</h3>
                <div style="display:flex; gap:10px;">
                    <button class="btn-create" id="addUserBtn"><i class="fas fa-plus"></i> Nuevo</button>
                    <i class="fas fa-times" onclick="document.getElementById('usersModal').classList.remove('active')" style="cursor:pointer; font-size:1.2rem; color:#999;"></i>
                </div>
            </div>
            <div class="users-body">
                <table class="user-table">
                    <thead><tr><th>Nombre</th><th>Email</th><th>Rol</th><th>Acciones</th></tr></thead>
                    <tbody id="usersTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
    <script>
        const API_URL = 'http://localhost:3001';
        let emailsData = [], contactsData = [], attachedFiles = [], editingDraftId = null;
        let searchTerm = "", sortOrder = "desc";
        let selectedTo = [], selectedCc = [], selectedBcc = [];
        
        let user = {};
        try { user = JSON.parse(localStorage.getItem('alhmail_user')) || {}; } catch(e) { user = {}; }
        const IS_ADMIN = user.role === 'admin';
        let selectedUserId = null; let isCreatingUser = false;

        var quill = new Quill('#editor-container', { theme: 'snow', placeholder: 'Escribe aquí...', modules: { toolbar: [['bold', 'italic'], ['link', 'clean']] } });

        document.addEventListener('DOMContentLoaded', () => {
            initData(); setInterval(initData, 20000);

            // LOGICA BOTONES
            const toggleBtn = document.getElementById('toggleBtn');
            if(toggleBtn) toggleBtn.onclick = () => document.getElementById('sidebar').classList.toggle('collapsed');

            const logoutBtn = document.getElementById('logoutBtn');
            if(logoutBtn) logoutBtn.onclick = () => Swal.fire({title:'¿Salir?', showCancelButton:true, confirmButtonColor:'#D50032'}).then(r=>{ if(r.isConfirmed){ localStorage.removeItem('alhmail_token'); window.location.href='index.html'; } });

            // BOTÓN ADMIN
            const adminBtn = document.getElementById('adminUsersBtn');
            if (IS_ADMIN && adminBtn) {
                document.getElementById('navSpam').style.display = 'flex';
                adminBtn.style.display = 'flex';
                adminBtn.onclick = () => { loadUsersTable(); document.getElementById('usersModal').classList.add('active'); };
            }

            // BOTÓN CUENTA
            document.getElementById('accountBtn').onclick = () => {
                isCreatingUser = false; selectedUserId = user.id;
                fillAccountForm(user, true);
                document.getElementById('accountModal').classList.add('active');
            };
            document.getElementById('closeAcc').onclick = () => {
                document.getElementById('accountModal').classList.remove('active');
                if((isCreatingUser || (IS_ADMIN && selectedUserId !== user.id)) && document.getElementById('usersModal').classList.contains('active')) {
                    // do nothing
                } else if(isCreatingUser) {
                    document.getElementById('usersModal').classList.add('active');
                }
            };

            document.getElementById('saveAcc').onclick = async () => {
                const data = { 
                    name: document.getElementById('accName').value, 
                    email: document.getElementById('accEmail').value, 
                    password: document.getElementById('accPass').value, 
                    role: document.getElementById('accRole').value 
                };
                
                try {
                    let res;
                    if(isCreatingUser) {
                        // POST para crear
                        res = await fetch(`${API_URL}/users`, {
                            method:'POST', 
                            headers:{'Content-Type':'application/json'}, 
                            body:JSON.stringify(data)
                        });
                    } else {
                        // PUT para editar
                        res = await fetch(`${API_URL}/users/${selectedUserId}`, {
                            method:'PUT', 
                            headers:{'Content-Type':'application/json'}, 
                            body:JSON.stringify(data)
                        });
                    }

                    // --- INICIO CAMBIO: Verificación de errores ---
                    if (!res.ok) {
                        // Si el servidor devuelve error (ej. email duplicado)
                        const errData = await res.json();
                        throw new Error(errData.message || 'Error al guardar');
                    }
                    // --- FIN CAMBIO ---

                    // Si es tu propia cuenta, actualizar localStorage
                    if(!isCreatingUser && selectedUserId === user.id) { 
                        user.name=data.name; 
                        user.role=data.role; 
                        localStorage.setItem('alhmail_user', JSON.stringify(user)); 
                        if(data.role!=='admin' && IS_ADMIN) location.reload(); 
                    }

                    Swal.fire({icon:'success', title:'Listo', timer:1000, showConfirmButton:false});
                    document.getElementById('accountModal').classList.remove('active');
                    
                    // Recargar tabla si eres admin
                    if(IS_ADMIN) { 
                        loadUsersTable(); 
                        document.getElementById('usersModal').classList.add('active'); 
                    }

                } catch(e) { 
                    // Mostrar el error real
                    Swal.fire({icon: 'error', title: 'Error', text: e.message}); 
                }
            };
            
            // CREAR USUARIO
            document.getElementById('addUserBtn').onclick = () => {
                isCreatingUser = true; selectedUserId = null;
                document.getElementById('usersModal').classList.remove('active');
                fillAccountForm({}, false); // empty form
                document.getElementById('accountModal').classList.add('active');
            };

            // CORREO
            document.querySelectorAll('.nav-item').forEach(item => { item.onclick = (e) => { e.preventDefault(); document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active')); item.classList.add('active'); renderEmails(item.dataset.target); } });
            document.getElementById('refreshBtn').onclick = () => { initData(); Swal.fire({toast:true, position:'top-end', icon:'info', title:'Actualizado', timer:1000}); };
            const modal = document.getElementById('composeModal');
            document.getElementById('composeBtn').onclick = () => { resetForm(); modal.classList.add('active'); };
            document.getElementById('btnCloseX').onclick = () => modal.classList.remove('active');
            document.getElementById('sendBtn').onclick = () => sendEmail(false);
            document.getElementById('discardBtn').onclick = () => { if(confirm("¿Descartar?")) { resetForm(); modal.classList.remove('active'); }};
            setupChipInput('to', selectedTo); setupChipInput('cc', selectedCc); setupChipInput('bcc', selectedBcc);
            const btnCc = document.getElementById('btnCc'), btnBcc = document.getElementById('btnBcc');
            btnCc.onclick = () => { document.getElementById('ccField').classList.remove('hidden-field'); btnCc.style.display='none'; document.getElementById('cc-input').focus(); };
            btnBcc.onclick = () => { document.getElementById('bccField').classList.remove('hidden-field'); btnBcc.style.display='none'; document.getElementById('bcc-input').focus(); };
        });

        // FUNCIONES DE APOYO
        async function loadUsersTable() {
            try {
                const res = await fetch(`${API_URL}/users`); const users = await res.json();
                const tbody = document.getElementById('usersTableBody'); tbody.innerHTML = '';
                users.forEach(u => {
                    tbody.innerHTML += `<tr><td>${u.name}</td><td>${u.email}</td><td><span class="role-tag ${u.role}">${u.role}</span></td><td><button class="btn-action btn-edit" onclick="editUser('${u.id}','${u.name}','${u.email}','${u.role}')"><i class="fas fa-pencil-alt"></i></button>${u.id!==user.id ? `<button class="btn-action btn-delete" onclick="deleteUser(${u.id})"><i class="fas fa-trash"></i></button>` : ''}</td></tr>`;
                });
            } catch(e){ console.log(e); }
        }
        window.editUser = (id, name, email, role) => {
            selectedUserId = id; isCreatingUser = false;
            document.getElementById('usersModal').classList.remove('active');
            fillAccountForm({name, email, role}, false);
            document.getElementById('accountModal').classList.add('active');
        };
        window.deleteUser = async (id) => { if(confirm("¿Borrar?")) { await fetch(`${API_URL}/users/${id}`, {method:'DELETE'}); loadUsersTable(); } };
        
        function fillAccountForm(data, isMyAccount) {
            document.getElementById('accName').value = data.name || '';
            document.getElementById('accEmail').value = data.email || '';
            document.getElementById('accPass').value = '';
            document.getElementById('accRole').value = data.role || 'user';
            const badge = document.getElementById('roleBadge');
            const roleSelect = document.getElementById('roleSelectContainer');
            
            document.getElementById('accEmail').disabled = !isCreatingUser; // Solo editable al crear
            
            if(isCreatingUser) {
                document.getElementById('accTitle').innerText = "Nuevo Usuario";
                badge.style.display = 'none'; roleSelect.style.display = 'block';
                document.getElementById('accName').disabled = false; document.getElementById('accPass').disabled = false;
                document.getElementById('saveAcc').style.display = 'inline-block';
            } else if(isMyAccount) {
                document.getElementById('accTitle').innerText = "Mi Cuenta";
                badge.style.display = 'inline-block'; roleSelect.style.display = 'none';
                if(IS_ADMIN) { badge.innerText = "ADMIN"; badge.className="role-badge role-admin"; document.getElementById('accName').disabled = false; document.getElementById('accPass').disabled = false; document.getElementById('saveAcc').style.display = 'inline-block'; } 
                else { badge.innerText = "USUARIO"; badge.className="role-badge role-user"; document.getElementById('accName').disabled = true; document.getElementById('accPass').disabled = true; document.getElementById('saveAcc').style.display = 'none'; }
            } else {
                // Editando a otro (Admin mode)
                document.getElementById('accTitle').innerText = "Editar Usuario";
                badge.style.display = 'none'; roleSelect.style.display = 'block';
                document.getElementById('accName').disabled = false; document.getElementById('accPass').disabled = false;
                document.getElementById('saveAcc').style.display = 'inline-block';
            }
        }

        // FUNCIONES CORREO (IGUAL QUE ANTES)
        async function initData() { try{ const res = await fetch(`${API_URL}/emails`); emailsData = await res.json(); renderEmails(document.querySelector('.nav-item.active').dataset.target); } catch(e){} }
        function renderEmails(folder) {
            const container = document.getElementById('emailContainer'); container.innerHTML = '';
            let filtered = emailsData.filter(e => e.folder === folder);
            if(filtered.length === 0) { container.innerHTML = '<div style="padding:40px;text-align:center;color:#999">Vacío</div>'; return; }
            filtered.forEach(email => {
                const el = document.createElement('div'); el.className = `fake-email ${email.unread?'unread':''}`;
                const fromLabel = email.sender.split('<')[0].replace(/"/g, '');
                el.innerHTML = `<input type="checkbox" class="email-check" data-id="${email.id}"><div class="email-content"><div class="email-row-top"><div class="email-from">${fromLabel}</div><span class="email-date">${new Date(email.date).toLocaleDateString()}</span></div><div class="email-to">Para: ${email.to_address || 'Mí'}</div><div class="email-subject">${email.subject}</div><div class="email-snippet">${email.preview.replace('Para: ? -','')}</div></div>`;
                el.querySelector('.email-content').onclick = () => viewEmail(email);
                container.appendChild(el);
            });
        }
        function viewEmail(email) {
            document.getElementById('previewPanel').innerHTML = `<div class="detail-wrapper"><div class="detail-header"><h2 class="detail-subject">${email.subject}</h2><div class="meta-container"><div class="sender-info"><div class="sender-avatar">${email.sender.charAt(0)}</div><div class="meta-text"><div class="from-line"><strong>De:</strong> ${email.sender}</div><div class="to-line"><strong>Para:</strong> ${email.to_address || 'Mí'}</div></div></div></div></div><div class="detail-body">${email.body}</div></div>`;
        }
        function setupChipInput(type, arr) { document.getElementById(`${type}-input`).addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ',') { e.preventDefault(); addChip(e.target.value, type, arr); } }); }
        function addChip(val, type, arr) { if(val){ arr.push(val); renderChips(type, arr); document.getElementById(`${type}-input`).value=''; } }
        function renderChips(type, arr) { const c = document.getElementById(`${type}-chips-container`); const i = document.getElementById(`${type}-input`); Array.from(c.getElementsByClassName('email-chip')).forEach(e=>e.remove()); arr.forEach(e => { const d=document.createElement('div'); d.className='email-chip'; d.innerText=e; c.insertBefore(d, i); }); }
        function resetForm() { document.getElementById('subject').value=''; quill.setText(''); document.getElementById('from').value = user.email; }
        async function sendEmail(isDraft) { Swal.fire('Enviado'); document.getElementById('composeModal').classList.remove('active'); }
        function handleFiles(files) {}
    </script>
</body>
</html>